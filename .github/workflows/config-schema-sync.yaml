# SPDX-FileCopyrightText: Contributors to PyPSA-Eur <https://github.com/pypsa/pypsa-eur>
#
# SPDX-License-Identifier: MIT

name: Check schema

on:
  push:
    branches:
    - master
  pull_request:
    branches:
    - master
    paths:
    - config/config.default.yaml
    - config/schema.json
    - scripts/lib/validation/config/**

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-config-sync:
    name: Check config files are in sync with schema
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.9.3
      with:
        pixi-version: v0.59.0
        cache: true
        cache-write: ${{ github.event_name == 'push' && github.ref_name == 'master' }}

    - name: Check config schema sync
      run: |
        pixi run generate-config
        if ! git diff --exit-code config/config.default.yaml config/schema.json; then
          echo ""
          echo "::error::'config/config.default.yaml' or 'config/schema.json' is out of sync with the Pydantic schema."
          echo "If changes to 'config/config.default.yaml' have been made, apply them to the Pydantic schema and regenerate via 'pixi run generate-config'."
          echo "If changes to the schema have been made, regenerate via 'pixi run generate-config'."
          exit 1
        fi
        echo "Config files are in sync with schema."
