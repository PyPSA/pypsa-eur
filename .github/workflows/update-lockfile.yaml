name: Update locked envs
on:
  push:
    paths:
    - pixi.toml
    - pixi.lock
  schedule:
  - cron: "0 8 1,16 * *" # Bi-weekly
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-diff:
    runs-on: ubuntu-latest
    outputs:
      has_diff: ${{ steps.check_diff.outputs.has_diff }}
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Check pixi files diff
      id: check_diff
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "has_diff=true" >> $GITHUB_OUTPUT
          echo "Running on master branch - will proceed with update of lockfiles."
          exit 0
        fi

        git fetch origin master
        if git diff origin/master...HEAD -- pixi.toml pixi.lock | grep -q .; then
          echo "has_diff=true" >> $GITHUB_OUTPUT
          echo "Differences found compared to master - will proceed with update of lockfiles."
        else
          echo "has_diff=false" >> $GITHUB_OUTPUT
          echo "No differences found compared to master - will skip update of lockfiles."
        fi
      env:
        GH_TOKEN: ${{ github.token }}

  update-locked-environment:
    if: |
      needs.check-diff.outputs.has_diff == 'true' &&
      (github.event_name != 'schedule' || github.ref == 'refs/heads/master')
    needs: check-diff
    name: Update lockfiles
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}
    steps:
    - uses: actions/checkout@v6

    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.9.3
      with:
        pixi-version: v0.59.0
        run-install: false

    - name: Update lockfile
      run: |
        rm pixi.lock
        pixi install --all

    - name: Create new conda lock files
      run: |
        pixi workspace export conda-explicit-spec -e default envs
        for f in envs/*_conda_spec*; do mv "$f" "${f/_conda_spec/.pin}"; done

    - name: Create new conda environment file
      run: |
        pixi workspace export conda-environment -e default envs/environment.yaml -n pypsa-eur

    - name: Upload artifacts
      uses: actions/upload-artifact@v6
      with:
        name: lockfiles
        path: |
          pixi.lock
          envs/

  create-commit:
    if: ${{ github.ref != 'refs/heads/master' }}
    needs: update-locked-environment
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Download all artifacts
      uses: actions/download-artifact@v6
      with:
        name: lockfiles

    - name: Create Commit
      uses: stefanzweifel/git-auto-commit-action@v7
      with:
        commit_message: "[github-actions.ci] Update locked envs"

  create-pull-request:
    if: ${{ github.ref == 'refs/heads/master' }}
    needs: update-locked-environment
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Download all artifacts
      uses: actions/download-artifact@v7
      with:
        name: lockfiles

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v8
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: update-locked-environment
        title: "[github-actions.ci] Update locked envs"
        body: |
          Automatically generated PR to update the pixi lockfile.

          **Note: Do not merge without manual test execution. Either update the branch to trigger tests, or use `workflow_dispatch` to run tests manually. Unlike standard PRs, tests will not run automatically.**
        commit-message: "Update locked environment files for all platforms"
